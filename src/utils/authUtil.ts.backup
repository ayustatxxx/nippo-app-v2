// utils/authUtil.ts - æœ€å°é™ä¿®æ­£ç‰ˆï¼ˆå®‰å…¨ï¼‰
import { User } from "../types";
import { DBUtil, STORES } from "./dbUtil";
// æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®å¾Œã«è¿½åŠ 
import { 
  createUserProfile, 
  getUser as getFirestoreUser 
} from '../firebase/firestore';

import { getCurrentUser as getFirebaseUser } from '../firebase/auth';
import { PermissionManager } from './permissionManager';

// ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
// Firebase + Firestoreå¯¾å¿œç‰ˆã®getCurrentUseré–¢æ•°
// ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆç°¡ç´ åŒ–ç‰ˆï¼‰
export const getCurrentUser = async (): Promise<User | null> => {
  try {
    console.log('getCurrentUser: å®Ÿè¡Œé–‹å§‹');
    
    // LocalStorageã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿã§é«˜é€Ÿï¼‰
    const userDataStr = localStorage.getItem('daily-report-user-data');
    const userId = localStorage.getItem('daily-report-user-id');
    
    if (userDataStr && userId) {
      try {
        const userData = JSON.parse(userDataStr);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ•´åˆæ€§ç¢ºèª
        if (userData.id === userId) {
          console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', userData.email || userData.username);
          return userData;
        } else {
          console.warn('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ä¸ä¸€è‡´ã‚’æ¤œå‡º:', {
            dataId: userData.id,
            storageId: userId
          });
          // ä¸æ•´åˆæ™‚ã¯LocalStorageã‚’ã‚¯ãƒªã‚¢
          localStorage.removeItem('daily-report-user-data');
          localStorage.removeItem('daily-report-user-id');
        }
      } catch (parseError) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', parseError);
        // ç ´æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        localStorage.removeItem('daily-report-user-data');
      }
    }
    
    console.log('æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return null;
    
  } catch (error) {
    console.error('getCurrentUser ã‚¨ãƒ©ãƒ¼:', error);
    return null;
  }
};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèªï¼ˆç®¡ç†è€…ã‹ã©ã†ã‹ï¼‰
export const isAdmin = async (groupId?: string): Promise<boolean> => {
  try {
    // æ–°ã—ã„æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
    return await PermissionManager.isAdmin(groupId);
  } catch (error) {
    console.error('æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®å®Ÿè£…ã‚’æ‹¡å¼µ
    try {
      // è¤‡æ•°ã®ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾å¿œ
      const adminEmails = ['info@ayustat.co.jp', 'sharaku@ayustat.co.jp'];
      
      // 1. daily-report-user-dataã‹ã‚‰å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
      const userDataStr = localStorage.getItem('daily-report-user-data');
      if (userDataStr) {
        const userData = JSON.parse(userDataStr);
        if (userData.role === 'admin' || (userData as any).systemRole === 'system_admin') {
          return true;
        }
        if (userData.email && adminEmails.includes(userData.email)) {
          return true;
        }
      }
      
      // 2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: daily-report-user-emailã‹ã‚‰å–å¾—
      const userEmail = localStorage.getItem("daily-report-user-email");
      const isAdminUser = userEmail && adminEmails.includes(userEmail);
      
      console.log('æ¨©é™ãƒã‚§ãƒƒã‚¯:', { 
        adminEmails, 
        userEmail, 
        isAdminUser 
      });
      
      return isAdminUser || false;
    } catch (fallbackError) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', fallbackError);
      return false;
    }
  }
};

// ã€ä¿®æ­£ç®‡æ‰€ã€‘ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå®Ÿè¨¼å®Ÿé¨“ç”¨ã«ç„¡åŠ¹åŒ–ï¼‰
export const setupDummyUsers = async (): Promise<void> => {
  console.log('ğŸš« å®Ÿè¨¼å®Ÿé¨“ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
  console.log('ğŸ’¡ å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„');
  
  // æ—¢å­˜ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆå‡¦ç†ã¯å…¨ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  /*
  const dbUtil = DBUtil.getInstance();
  await dbUtil.initDB();
  
  // æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèª
  const users = await dbUtil.getAll<User>(STORES.USERS);
  if (users.length > 0) return; // ã™ã§ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚Œã°ä½•ã‚‚ã—ãªã„
  
  // ä»¥ä¸‹ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆã¯å®Ÿè¨¼å®Ÿé¨“ã§ã¯ä½¿ç”¨ã—ãªã„
  */
  
  return;
};

// æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ 
export const getUserRole = async (): Promise<'admin' | 'user'> => {
  const adminStatus = await isAdmin();
  return adminStatus ? 'admin' : 'user';
};


// è¡¨ç¤ºåã‚’çµ±ä¸€çš„ã«å–å¾—ã™ã‚‹é–¢æ•°
export const getDisplayName = async (userId?: string): Promise<string> => {
  try {
    let targetUserId = userId;
    
    // userIdãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
    if (!targetUserId) {
      const currentUser = await getCurrentUser();
      targetUserId = currentUser?.id;
    }
    
    if (!targetUserId) {
      return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
    }
    
    // 1. Firestoreã‹ã‚‰æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const firestoreUser = await getFirestoreUser(targetUserId);
    if (firestoreUser) {
      // å„ªå…ˆé †ä½: displayName > username > id
      return firestoreUser.displayName || firestoreUser.username || firestoreUser.id;
    }
    
    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!userId) { // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
      const displayName = localStorage.getItem("daily-report-displayname");
      const username = localStorage.getItem("daily-report-username");
      if (displayName) return displayName;
      if (username) return username;
    }
    
    return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
    
  } catch (error) {
    console.error('è¡¨ç¤ºåå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
  }
};

// è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¤ºåã‚’ä¸€æ‹¬å–å¾—ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆç”¨ï¼‰
export const getDisplayNames = async (userIds: string[]): Promise<{[key: string]: string}> => {
  const result: {[key: string]: string} = {};
  
  for (const userId of userIds) {
    result[userId] = await getDisplayName(userId);
  }
  
  return result;
};


// æ–°ã—ã„æ¨©é™ç®¡ç†é–¢æ•°
export const canCreateGroup = async (): Promise<boolean> => {
  try {
    return await PermissionManager.canCreateGroup();
  } catch (error) {
    console.error('ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰ä½œæˆå¯èƒ½
    const currentUser = await getCurrentUser();
    return !!currentUser;
  }
};

export const isGroupAdmin = async (groupId: string, userId?: string): Promise<boolean> => {
  try {
    return await PermissionManager.isGroupAdmin(groupId, userId);
  } catch (error) {
    console.error('ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    return await isAdmin();
  }
};


